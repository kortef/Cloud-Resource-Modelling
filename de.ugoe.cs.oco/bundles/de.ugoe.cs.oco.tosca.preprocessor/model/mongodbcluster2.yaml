tosca_definitions_version: cloudify_dsl_1_2
imports:
  - http://www.getcloudify.org/spec/cloudify/4.0m10/types.yaml
  - http://www.getcloudify.org/spec/fabric-plugin/1.4.2/plugin.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/2.0.1/plugin.yaml
  - http://user.informatik.uni-goettingen.de/~fglaser/cloudify-ansible-plugin/plugin.yaml

node_templates:
  swe.simpaas.instances.floating_ip:
    type: cloudify.openstack.nodes.FloatingIP
    properties:
      openstack_config:       floatingip: 
        floating_network_name: provider

  mongoscale.apps.shard:
    type: ansible.nodes.Application
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
          inputs:
            rolesfile: roles.zip
            roles: [common, avahi, shard]
            keypair: /root/.ssh/mongoscale-key.pem
            private_ip_address: {get_attribute: [mongoscale.hosts.shard, ip]}
            user: ubuntu
    relationships:
      - type: cloudify.relationships.contained_in
        target: mongoscale.hosts.shard

  mongoscale.apps.router:
    type: ansible.nodes.Application
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
          inputs:
            rolesfile: roles.zip
            roles: [common, avahi, configserver]
            keypair: /root/.ssh/mongoscale-key.pem
            private_ip_address: {get_attribute: [mongoscale.hosts.router, ip]}
            user: ubuntu
    relationships:
      - type: cloudify.relationships.contained_in
        target: mongoscale.hosts.router

  mongoscale.hosts.router:
    type: mongoscale.host
    properties:
      openstack_config:       management_network_name:       agent_config:       server: 
        image: 
        flavor: 
        name: router
    relationships:
      - type: cloudify.openstack.server_connected_to_floating_ip
        target: swe.simpaas.instances.floating_ip
      - type: cloudify.openstack.server_connected_to_keypair
        target: mongoscale-key

  mongoscale-key:
    type: cloudify.openstack.nodes.KeyPair
    properties:
      openstack_config:       use_external_resource: false
      resource_id:       private_key_path: 
  mongoscale.hosts.shard:
    type: mongoscale.host
    properties:
      openstack_config:       management_network_name:       agent_config:       server: 
        image: 
        flavor: 
        name: sh1rep1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: mongoscale-key

